---
title: "DNR Nearshore Sampling Data Summary 9/12/24"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(targets)
library(tidyverse)
library(plotly)
library(DT)
library(gganimate)
library(sf)
dnr <- tar_read(dnr)
ls_crop_dnr <- tar_read(ls_crop_dnr)
dnr_round <- dnr %>% 
  filter(!is.na(site)) %>% 
  mutate(date = floor_date(date, "week"))

```


### First, a few QC notes
Some suspicious pH values on 6/29/22, 7/12/22, and 8/9/22 (< 6) as well as 7/13/22 to a lesser extent (low 6s).
```{r ph, echo=FALSE}
plot <- dnr %>% 
  ggplot() + 
    geom_point(aes(x = date, y = ph, label = site))
ggplotly(plot)  
```


Some suspicious conductivity values on 8/12/19, 8/15/19, 9/23/19, and 9/24/19 (< 90 uS/cm).
```{r cond, echo=FALSE}
plot <- dnr %>% 
  ggplot() + 
    geom_point(aes(x = date, y = cond, label = site))
ggplotly(plot)  
```


DO is consistently (and oddly) high in 2023. Also, 8/22/22 has notably low DO. July 2022 also has somewhat high DO.
```{r do, echo=FALSE}
plot <- dnr %>% 
  mutate(year = year(date),
         year = as_factor(year)) %>% 
  ggplot() + 
    geom_point(aes(x = temp, y = do, color = year, label = date))
ggplotly(plot)  
plot <- dnr %>% 
  mutate(year = year(date),
         year = as_factor(year)) %>% 
  ggplot() + 
    geom_point(aes(x = temp, y = do_sat, color = year, label = date))
ggplotly(plot)
plot <- dnr %>% 
  mutate(year = year(date),
         year = as_factor(year)) %>% 
  ggplot() + 
    geom_point(aes(x = do, y = do_sat, color = year, label = date))
ggplotly(plot)
```


Any guesses on why this might be happening? I'm currently not dropping any of these suspicious values, but I'm leaning towards dropping the ph and conductivity values and potentially adjusting down all of the 2023 DO values.

## Correlations between variables

Here's a plot showing spearman correlation coefficients between variables. Bigger size/darker color means a stronger correlation. Only correlations with P < 0.05 are shown.

```{r corr, echo=FALSE}
corrplot::corrplot(tar_read(dnr_corr)$r, type = "lower", tl.cex = .5, p.mat = tar_read(dnr_corr)$P, sig.level = 0.05, insig = 'blank', outline = T)
```

The main takeaway is there is one big group of variables that are all correlated with each other: chlorophyll a, TSS, NH3, TN, PO4, TP, DOC, conductivity, and turbidity. (With a notable exception being that NH3 and conductivity are inversely correlated.) NO3 is inversely correlated with almost every member of that group. 
Other notes: Temperature has clear inverse correlations with nitrogen species. Conductivity is inversely correlated with NH3 and NO3, but is positively correlated with TN. pH drops when TN and TP increase.

## Site Cluster Analysis

Both of these plots show the results of PCA on the median values of variables at each site. The first shows how each variable is related to the principal components, while the second plot shows groups based on a K-means cluster analysis.
```{r cluster, echo=FALSE}
biplot(tar_read(dnr_site_clus_pca))
factoextra::fviz_cluster(tar_read(dnr_site_clus_kmean), data = tar_read(dnr_site_clus_prep))
```

It's pretty clear to see that PC1 is basically a measure of the large group of correlated variables from above, though without TSS. This is because most sites had a very low median TSS. TSS is represented within PC2, which is why site 7 (2x median TSS of all other sites) is way off on its own.

The sites are also split into two groups, along PC1. Interesting, this split is also geographic! Western sites (1-7) typically have higher group A variables (everything but NO3 and DO), while Eastern sites (9-15) typically have lower. Site 8 is more closely related to the Eastern sites, but somewhat straddles the two. 

Looking at a map, it seems as if the Eastern sites would receive more runoff--is this the case? That would explain why site 15 has some similarities to them, since (I think) it's at the mouth of the Siskiwit.

Here's a table of median values for each site for your perusal (most values in mg/L, chl in ug/L):
```{r compare 7, echo=FALSE}


dnr %>% 
               sf::st_drop_geometry() %>%  
               select(-c(date, station, nh3, doc, do_sat, chl_f)) %>% 
               filter(!is.na(site)) %>% 
               mutate(site = as.factor(site)) %>% 
               group_by(site) %>% 
               summarise(chl = median(chl, na.rm = T),
                         tss = median(tss, na.rm = T),
                         no3 = median(no3, na.rm = T),
                         tn = median(tn, na.rm = T),
                         po4 = median(po4, na.rm = T),
                         tp = median(tp, na.rm = T),
                         temp = round(median(temp, na.rm = T),2),
                         do = round(median(do, na.rm = T),2),
                         cond = round(median(cond, na.rm = T),2),
                         ph = round(median(ph, na.rm = T),2),
                         turb = round(median(turb, na.rm = T),2)) %>% 
  datatable()

```

And plots comparing variables across the two groups (with a few high outliers dropped for tss, tp, tn, and turbidity):

```{r group_plots, echo=FALSE, fig.width=3, fig.height=5}
dnr_groups <- dnr %>% 
  filter(!is.na(site)) %>% 
  mutate(group = if_else(site > 7, "east", "west"),
         group = as_factor(group))

ggplot(data = dnr_groups, aes(x = group, y = chl)) +
  geom_boxplot()
dnr_groups %>%
  filter(tss < 50) %>%
  ggplot(aes(x = group, y = tss)) +
  geom_boxplot()
dnr_groups %>%
  filter(tp < 0.05) %>%
  ggplot(aes(x = group, y = tp)) +
  geom_boxplot()
dnr_groups %>%
  filter(tn < 1) %>%
  ggplot(aes(x = group, y = tn)) +
  geom_boxplot()
ggplot(data = dnr_groups, aes(x = group, y = temp)) +
  geom_boxplot()
ggplot(data = dnr_groups, aes(x = group, y = cond)) +
  geom_boxplot()
dnr_groups %>%
  filter(turb < 100) %>%
  ggplot(aes(x = group, y = turb)) +
  geom_boxplot()
ggplot(data = dnr_groups, aes(x = group, y = ph)) +
  geom_boxplot()
ggplot(data = dnr_groups, aes(x = group, y = no3)) +
  geom_boxplot()
ggplot(data = dnr_groups, aes(x = group, y = do)) +
  geom_boxplot()

```


## Maps!
These include some outliers and the suspicious data mentioned above, since I thought it would be good to be able to see those values in context. Let me know if you know would like versions of these without outliers, or if there are other maps you would like to see!
```{r mapchl, echo=FALSE, fig.height=2}
plotchl <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(chl)), mapping = aes(color = chl), size = 7) +
               scale_color_gradient(low = "#d7f4cb", high = "darkgreen") +
               transition_states(date) +
               labs(title = "CHL on Week of {closest_state}")
animate(plotchl, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r maptss, echo=FALSE, fig.height=2}
plottss <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(tss)), mapping = aes(color = tss), size = 7) +
               scale_color_gradient(low = "lightblue", high = "tan4") +
               transition_states(date) +
               labs(title = "TSS on Week of {closest_state}")
animate(plottss, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r maptp, echo=FALSE, fig.height=2}
plottp <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(tp)), mapping = aes(color = tp), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "TP on Week of {closest_state}")
animate(plottp, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r maptn, echo=FALSE, fig.height=2}
plottn <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(tn)), mapping = aes(color = tn), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "TN on Week of {closest_state}")
animate(plottn, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r mapno3, echo=FALSE, fig.height=2}
plotno3 <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(no3)), mapping = aes(color = no3), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "NO3 on Week of {closest_state}")
animate(plotno3, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r mapturb, echo=FALSE, fig.height=2}
plotturb <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(turb)), mapping = aes(color = turb), size = 7) +
               scale_color_gradient(low = "lightblue", high = "tan4") +
               transition_states(date) +
               labs(title = "Turbidity on Week of {closest_state}")
animate(plotturb, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r mapcond, echo=FALSE, fig.height=2}
plotcond <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(cond)), mapping = aes(color = cond), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "Conductivity on Week of {closest_state}")
animate(plotcond, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r mapph, echo=FALSE, fig.height=2}
plotph <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(ph)), mapping = aes(color = ph), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "pH on Week of {closest_state}")
animate(plotph, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r mapdo, echo=FALSE, fig.height=2}
plotdo <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(do)), mapping = aes(color = do), size = 7) +
               scale_color_gradient(low = "lightblue", high = "darkblue") +
               transition_states(date) +
               labs(title = "DO on Week of {closest_state}")
animate(plotdo, nframes = length(unique(dnr_round$date)), fps = 1)
```
```{r maptemp, echo=FALSE, fig.height=2}
plottemp <-  ggplot() +
               theme_bw() +
               geom_sf(data = ls_crop_dnr) +
               geom_sf(data = filter(dnr_round, !is.na(temp)), mapping = aes(color = temp), size = 7) +
               scale_color_gradient(low = "lightblue", high = "indianred2") +
               transition_states(date) +
               labs(title = "Temperature on Week of {closest_state}")
animate(plottemp, nframes = length(unique(dnr_round$date)), fps = 1)
```


## Variable Importance (random forest)
Just in case you aren't familiar, random forest models involve making a bunch a decision trees based on random subsets of a dataset. Looking at the common themes among different trees can help you understand trends in the data.

These tables show various measures of importance of variables to each model. With the exception of mean_min_depth, a higher value means the variable is more important. MSE increase is the measure I put the most weight in, since it actually measures the importance of the variable to predict chl a, whereas others tell you more about how integral the variable is to the model itself. Mean min depth is the mean level of the decision tree the variable appears at, number of nodes is the total number nodes that use the variable across all trees (500), node purity increase is measures how often a node with that variable leads to a single outcome, and number of times a root is just how often that variable was the base of a tree.

For this first model, I included all parameters that had 3+ years of data. Month is month of the year, to see if chlorophyll varied across the summer in any predictable manner. 
```{r rf_full, echo=FALSE}
importance <- randomForestExplainer::measure_importance(tar_read(dnr_rf_full)) %>% 
  mutate(mse_increase = round(mse_increase, 3),
         mean_min_depth = round(mean_min_depth, 2),
         node_purity_increase = round(node_purity_increase, 2)) %>% 
  select(-c(p_value, no_of_trees))
datatable(importance)
```

Interestingly, the water quality variables come out as more important than the chemical variables on the whole, despite being less correlated (except conductivity) with chlorophyll than TP and NO3. Still, it is a nice reminder that temperature does impact phytoplankton growth. Conductivity's importance may be a sign that loading from tributaries is playing a role. Site was quite important in all measures except mse_increase, which I interpret as site being important at a low level, in that only some sites ever had high chl, but knowing the site couldn't really help you predict its chlorophyll concentration on a given day. Also notable is that month was not very important, so we aren't seeing patterns in chl across the summer.


For this second model, I only included water chemistry (nutrients + TSS) parameters since they were less important (and so harder to compare to each other) in the full random forest model.
```{r rf_chem, echo=FALSE}
importance <- randomForestExplainer::measure_importance(tar_read(dnr_rf_chem)) %>% 
  mutate(mse_increase = round(mse_increase, 3),
         mean_min_depth = round(mean_min_depth, 2),
         node_purity_increase = round(node_purity_increase, 2)) %>% 
  select(-c(p_value, no_of_trees))
datatable(importance)
```

P seems to be more important than N in general, and TSS is the least important. TP is more important than PO4, but NO3 is more important than TN. The TSS result does line up with what Ellen and others have found in the past, where TSS hampers bloom growth despite (often) being rich in nutrients.

My plan is to go deeper on actually trying to model/predict blooms once I've added in more data (particularly tributaries). I included these initial random forest models so we can see if and how they change as more sources of data are added.

## Plots of Chlorophyll vs everything else
In case you were curious what these relationships with chlorophyll look like plotted, here you go. To me, the most interesting thing about these plots is how the high chl observations (>3 ug/L) don't fit into the pretty clear trends visible in the plots for conductivity, TN, NO3, and TP. (Try zooming in past the outliers for a better look.) Hopefully adding more data and having additional discussions can help figure out what else is responsible for these high chlorophyll concentrations.

```{r chlplots, echo=FALSE}
ggplotly(dnr %>% 
  ggplot(aes(x = temp, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = do, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = ph, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = turb, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = cond, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = po4, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = tp, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = no3, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = tn, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
ggplotly(dnr %>%
  ggplot(aes(x = tss, y = chl, text = str_c("site", site, date, sep = " "))) +
  geom_point())
```


